{% extends 'dashboard/base.html' %}

<!-- Bootstrap CDN link  -->
{% block bootstrapcdn %}
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}


{% block title %}Analyse #{{ check.id }} - Détail{% endblock %}
{% block page_title %}Détail de l'analyse{% endblock %}


{% block content %}
<div class="row">
  <div class="col-md-8">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Résultat:
            {% if check.result and check.result.lower() == 'conforme' %}
              <span class="badge bg-success">Conforme</span>
            {% elif check.result %}
              <span class="badge bg-danger">Non Conforme</span>
            {% else %}
              <span class="text-muted">En attente</span>
            {% endif %}
          </h5>


          <h6>Détails</h6>
          {% if check.detail %}
          <div id="ai-detail" class="border rounded p-3 mb-3" style="white-space: pre-wrap; ">{{ check.detail }}</div>
          {% else %}
          <div class="text-muted">Aucun détail disponible pour le moment.</div>
          {% endif %}

        <h6>Fichiers fournis</h6>
        <ul>
          {% for f in check.input_files.split(';') if check.input_files %}
          <li><a href="{{ url_for('download_file', filename=f) }}" target="_blank">{{ f }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>

    {% if check.output_files %}
    <div class="card mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6>Rapport généré</h6>
          <div class="small text-muted">Téléchargez le résumé PDF de l'analyse.</div>
        </div>
        <div>
          <a class="btn btn-outline-primary" href="{{ url_for('download_file', filename=check.output_files) }}"><i class="bi bi-download"></i> Télécharger </a>
        </div>
      </div>
    </div>
    {% endif %}

  </div>

  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-body">
        <h6>Informations</h6>
        <p class="mb-1"><strong>Module:</strong> {{ check.module }}</p>
        <p class="mb-1"><strong>Demandé le:</strong> {{ check.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
        <p class="mb-1"><strong>Statut paiement:</strong>
        {% if check.has_paid %}<span class="badge bg-success">Payé</span>{% else %}<span class="badge bg-warning text-dark">En attente</span>{% endif %}
        </p>


        {% if not check.has_paid %}
        <div class="mt-3">
          <a class="btn btn-primary w-100" href=""><i class="bi bi-credit-card"></i> Payer 2 €</a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h6>Actions</h6>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}"><i class="bi bi-arrow-left"></i> Retour à la liste</a>
          {% if check.has_paid and check.result %}
          <a class="btn btn-outline-success" href="">Contester / demander aide</a>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const detailDiv = document.getElementById("ai-detail");
  if (detailDiv) {
    const rawMarkdown = detailDiv.textContent;
    detailDiv.innerHTML = marked.parse(rawMarkdown);
  }
</script>

{% endblock %}